<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini Blog By Huy</title>
    <link rel="stylesheet" href="./style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
</head>

<body>
    <div class="wrapper">
        <div class="top-bar">
            <div class="d-flex align-items-center me-auto">
                <label for="pageSize" class="form-label mb-0 me-2">Posts per page:</label>
                <select id="pageSize" class="form-select form-select-sm" style="width:auto;">
                    <option value="5">5</option>
                    <option value="10" selected>10</option>
                    <option value="15">15</option>
                    <option value="20">20</option>
                </select>

                <div id="paginationControls" class="ms-3"></div>
            </div>

            <!-- Button trigger modal -->
            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
                Add Post
            </button>
        </div>
        <div class="flex-container" id="container"></div>

        <!-- Modal Add Post-->
        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="exampleModalLabel">Your new post</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="input-wrapper">
                            <input type="number" class="input-tag" id="userId" placeholder=" " />
                            <label for="userId">User ID</label>
                        </div>
                        <div class="input-wrapper">
                            <input type="text" class="input-tag" id="title" placeholder=" " />
                            <label for="title">Title</label>
                        </div>
                        <div class="input-wrapper">
                            <input type="text" class="input-tag" id="body" placeholder=" " />
                            <label for="body">Content</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary">Save</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Edit Post -->
        <div class="modal fade" id="viewModal" tabindex="-1" aria-labelledby="viewModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">

                    <!-- Header -->
                    <div class="modal-header">
                        <h5 class="modal-title" id="viewModalLabel">Post Detail</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <!-- Body -->
                    <div class="modal-body">
                        <input type="hidden" id="viewPostId">

                        <!-- View Mode -->
                        <div id="viewMode">
                            <p><strong>Title:</strong> <span id="viewTitle"></span></p>
                            <p><strong>Body:</strong> <span id="viewBody"></span></p>
                            <p><strong>User ID:</strong> <span id="viewUserId"></span></p>
                        </div>

                        <!-- Edit Mode -->
                        <div id="editMode" style="display: none;">
                            <div class="mb-3">
                                <label for="editTitle" class="form-label">Title</label>
                                <input type="text" id="editTitle" class="form-control">
                            </div>
                            <div class="mb-3">
                                <label for="editBody" class="form-label">Body</label>
                                <textarea id="editBody" class="form-control"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="editUserId" class="form-label">User ID</label>
                                <input type="number" id="editUserId" class="form-control">
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" id="removeBtn" class="btn btn-danger">Remove</button>
                        <button type="button" id="editBtn" class="btn btn-warning">Edit</button>
                        <button type="button" id="saveBtn" class="btn btn-primary" style="display: none;">Save</button>
                    </div>

                </div>
            </div>
        </div>


        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
            crossorigin="anonymous"></script>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                let allPosts = [];
                let currentPage = 1;
                let pageSize = 10;

                async function getData() {
                    try {
                        const res = await fetch("https://jsonplaceholder.typicode.com/posts", { method: "GET" });
                        return await res.json();
                    } catch (err) {
                        console.error(err);
                    }
                }

                function truncateText(text, maxLength = 15) {
                    return text.length > maxLength ? text.substring(0, maxLength) + "..." : text;
                }

                function renderPosts() {
                    const container = document.getElementById("container");
                    container.innerHTML = "";

                    const startIndex = (currentPage - 1) * pageSize;
                    const endIndex = startIndex + pageSize;
                    const pagePosts = allPosts.slice(startIndex, endIndex);

                    pagePosts.forEach(blog => {
                        let card = document.createElement("div");
                        card.className = "card m-2 p-2";
                        card.style.width = "18rem";
                        // Gắn attribute data-post-id để sau này tìm và xóa
                        card.setAttribute("data-post-id", blog.id);
                        card.innerHTML = `
                            <h6>Post ID: ${blog.id} - User ${blog.userId}</h6>
                            <div class="card-body">
                                <h5 class="card-title">${truncateText(blog.title)}</h5>
                                <p class="card-text">${truncateText(blog.body)}</p>
                            </div>
                            `;

                        // Click card → mở modal ở view mode
                        card.addEventListener("click", () => {
                            document.getElementById("viewPostId").value = blog.id;
                            document.getElementById("viewTitle").textContent = blog.title;
                            document.getElementById("viewBody").textContent = blog.body;
                            document.getElementById("viewUserId").textContent = blog.userId;

                            // Reset về view mode
                            document.getElementById("viewMode").style.display = "block";
                            document.getElementById("editMode").style.display = "none";
                            document.getElementById("editBtn").style.display = "inline-block";
                            document.getElementById("saveBtn").style.display = "none";

                            new bootstrap.Modal(document.getElementById("viewModal")).show();
                        });

                        container.appendChild(card);
                    });

                    renderPaginationControls();
                }

                function renderPaginationControls() {
                    const totalPages = Math.ceil(allPosts.length / pageSize);
                    const pagination = document.getElementById("paginationControls");
                    pagination.innerHTML = "";

                    function createPageButton(page, label = null, disabled = false) {
                        let btn = document.createElement("button");
                        btn.className = `btn btn-sm ${page === currentPage ? "btn-primary" : "btn-outline-primary"}`;
                        btn.textContent = label || page;
                        btn.disabled = disabled;
                        btn.addEventListener("click", () => {
                            if (page !== currentPage && !disabled) {
                                currentPage = page;
                                renderPosts();
                            }
                        });
                        pagination.appendChild(btn);
                    }

                    function createEllipsis() {
                        let span = document.createElement("span");
                        span.textContent = "...";
                        span.className = "mx-1";
                        pagination.appendChild(span);
                    }

                    // Nút Prev
                    createPageButton(currentPage - 1, "Prev", currentPage === 1);

                    if (totalPages <= 10) {
                        // Hiển thị toàn bộ trang
                        for (let i = 1; i <= totalPages; i++) {
                            createPageButton(i);
                        }
                    } else {
                        // Trang 1 luôn hiện
                        createPageButton(1);

                        // Ellipsis trước vùng giữa
                        if (currentPage > 4) createEllipsis();

                        // Vùng giữa: từ currentPage - 1 đến currentPage + 1
                        let start = Math.max(2, currentPage - 1);
                        let end = Math.min(totalPages - 1, currentPage + 1);
                        for (let i = start; i <= end; i++) {
                            createPageButton(i);
                        }

                        // Ellipsis sau vùng giữa
                        if (currentPage < totalPages - 3) createEllipsis();

                        // Trang cuối luôn hiện
                        createPageButton(totalPages);
                    }

                    // Nút Next
                    createPageButton(currentPage + 1, "Next", currentPage === totalPages);
                }


                document.getElementById("pageSize").addEventListener("change", (e) => {
                    pageSize = parseInt(e.target.value);
                    currentPage = 1;
                    renderPosts();
                });

                getData().then(blogList => {
                    allPosts = blogList;
                    renderPosts();
                });

                // Nút Edit → chuyển sang edit mode
                document.getElementById("editBtn").addEventListener("click", () => {
                    // Lấy dữ liệu từ view để điền vào input
                    document.getElementById("editTitle").value = document.getElementById("viewTitle").textContent;
                    document.getElementById("editBody").value = document.getElementById("viewBody").textContent;
                    document.getElementById("editUserId").value = document.getElementById("viewUserId").textContent;

                    // Chuyển chế độ
                    document.getElementById("viewMode").style.display = "none";
                    document.getElementById("editMode").style.display = "block";
                    document.getElementById("editBtn").style.display = "none";
                    document.getElementById("saveBtn").style.display = "inline-block";
                });

                // Nút Save → gọi API PUT
                document.getElementById("saveBtn").addEventListener("click", async () => {
                    const id = document.getElementById("viewPostId").value;
                    const title = document.getElementById("editTitle").value;
                    const body = document.getElementById("editBody").value;
                    const userId = document.getElementById("editUserId").value;

                    try {
                        const res = await fetch(`https://jsonplaceholder.typicode.com/posts/${id}`, {
                            method: 'PUT',
                            body: JSON.stringify({ id, title, body, userId }),
                            headers: { 'Content-type': 'application/json; charset=UTF-8' }
                        });

                        const json = await res.json();
                        console.log("Updated Post:", json);

                        // Sau khi save, cập nhật view mode ngay
                        document.getElementById("viewTitle").textContent = title;
                        document.getElementById("viewBody").textContent = body;
                        document.getElementById("viewUserId").textContent = userId;

                        // Chuyển lại view mode
                        document.getElementById("viewMode").style.display = "block";
                        document.getElementById("editMode").style.display = "none";
                        document.getElementById("editBtn").style.display = "inline-block";
                        document.getElementById("saveBtn").style.display = "none";

                    } catch (err) {
                        console.error(err);
                    }
                });

                document.getElementById("removeBtn").addEventListener("click", async function () {
                    const postId = document.getElementById("viewPostId").value;

                    if (confirm("Are you sure you want to remove this post?")) {
                        try {
                            const res = await fetch(`https://jsonplaceholder.typicode.com/posts/${postId}`, {
                                method: 'DELETE',
                            });

                            if (res.ok) {
                                alert(`Post ${postId} removed successfully!`);
                                // Xóa card trên UI
                                document.querySelector(`[data-post-id="${postId}"]`)?.remove();
                                // Đóng modal
                                const modalEl = document.getElementById("viewModal");
                                const modal = bootstrap.Modal.getInstance(modalEl);
                                modal.hide();
                            } else {
                                alert("Failed to remove post.");
                            }
                        } catch (err) {
                            console.error(err);
                            alert("Error occurred while removing post.");
                        }
                    }
                });

                const saveBtn = document.querySelector("#exampleModal .btn-primary");

                saveBtn.addEventListener("click", async function () {
                    // Lấy giá trị từ input
                    const userId = document.getElementById("userId").value;
                    const title = document.getElementById("title").value;
                    const body = document.getElementById("body").value;

                    // Gọi API POST
                    try {
                        const res = await fetch('https://jsonplaceholder.typicode.com/posts', {
                            method: 'POST',
                            body: JSON.stringify({
                                title: title,
                                body: body,
                                userId: parseInt(userId),
                            }),
                            headers: {
                                'Content-type': 'application/json; charset=UTF-8',
                            },
                        });

                        const json = await res.json();
                        console.log("Kết quả trả về:", json);

                        // Nếu muốn đóng modal sau khi lưu
                        const modalElement = document.getElementById('exampleModal');
                        const modalInstance = bootstrap.Modal.getInstance(modalElement);
                        modalInstance.hide();

                        // Xoá dữ liệu input sau khi lưu
                        document.getElementById("userId").value = "";
                        document.getElementById("title").value = "";
                        document.getElementById("body").value = "";
                    } catch (err) {
                        console.error("Lỗi khi gọi API:", err);
                    }
                });
            });

        </script>
</body>

</html>